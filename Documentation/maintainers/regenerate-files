#!/bin/bash

SCRIPT=`basename $0`
if [[ ! -f "${PWD}/${SCRIPT}" ]]; then
	echo "You need to be in '"`dirname $0`"' dir to run this script."
	exit -1
fi

USERNAME=${USER}
[[ -n ${ECHANGELOG_USER} ]] && USERNAME=${ECHANGELOG_USER}

HEADER="\
# ${USERNAME} ("`LC_ALL=C date +"%d %b %Y"`")
# Autogenerated by ${SCRIPT}, DO NOT EDIT."

# regenerate KDE 3.5 keywords
pushd ../package.keywords/ > /dev/null
echo -e "\
${HEADER}
# Combined KDE 3.5 package.keywords file." > kde-3.5.keywords
if [[ -d kde-3.5.d ]]; then
	cat kde-3.5.d/* >> kde-3.5.keywords
fi
popd > /dev/null

# regenerate package.use entries
# no live, because live defaults to +kdeprefix anyway
pushd ../package.use.unsupported/ > /dev/null
for release in 4.2 4.3; do
	echo -e "${HEADER}" > "kde-${release}"
	if [[ -d "kde-${release}.d" ]]; then
		# this sed script will only include comments, blank lines, and lines
		# that start with "kde-base/", and add a tab followed by "kdeprefix"
		# to the end of lines starting with "kde-base/"
		cat "kde-${release}.d"/* | sed -n $'/^$/p;/^#/p;/^kde-base\//{s/$/\tkdeprefix/;p}' >> "kde-${release}"
	fi
done
popd > /dev/null

# regenerate unmask entries (base for package mask)
pushd ../package.unmask/ > /dev/null
for release in 4.2 4.3 live; do
	echo -e "${HEADER}" > "kde-${release}"
	if [[ -d "kde-${release}.d" ]]; then
		cat "kde-${release}.d/"* >> "kde-${release}"
	fi
done
popd > /dev/null

# regenerate package mask
pushd ../../profiles/ > /dev/null
echo -e "\
${HEADER}
# Edit profiles/package.mask.d/ files instead." > package.mask
if [[ -d package.mask.d ]]; then
	for masks in package.mask.d/*; do
		echo >> package.mask
		cat ${masks} >> package.mask
	done
fi
popd > /dev/null
