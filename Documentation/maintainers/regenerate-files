#!/bin/bash

# Make sure that all systems have the same sort order and date format
export LC_ALL=C

SCRIPT=`basename $0`
if [[ ! -f "${PWD}/${SCRIPT}" ]]; then
	echo "You need to be in '"`dirname $0`"' dir to run this script."
	exit -1
fi

HEADER="# Autogenerated by ${SCRIPT}, DO NOT EDIT."

# regenerate keywords
pushd ../package.keywords/ > /dev/null
for release in 4.8 4.9; do
	echo -e "${HEADER}" > "kde-${release}.keywords"
	if [[ -d ".kde-${release}" ]]; then
		cat ".kde-${release}/"* | sed '/^~.*[.-]9999$/s/$/ **/' >> "kde-${release}.keywords"
	fi
done

# ... and for completely unkeyworded packages, add "**"
for release in 4.9; do
	if [[ -d ".kde-${release}" ]]; then
		rm -rf ".kde-${release}.49.9999"
		mkdir -p ".kde-${release}.49.9999"
		echo -e "${HEADER}" > "kde-${release}.49.9999.keywords"
		for file in ".kde-${release}"/*; do
			newfile=".kde-${release}.49.9999"/$(basename "${file}")
			sed "/^<kde-base\/.*-4\..\.50$/{s/-4\..\.50/-${release}.49.9999/;s/^</~/};/^~.*[.-]9999$/s/$/ **/" "${file}" > "${newfile}"
		done
		cat ".kde-${release}.49.9999"/* >> "kde-${release}.49.9999.keywords"
	fi
done

if [[ -d .kde-live.base ]]; then
	rm -rf .kde-live
	mkdir -p .kde-live
	echo -e "${HEADER}" > kde-live.keywords
	for file in .kde-live.base/*; do
		newfile=.kde-live/$(basename "${file}")
		sed '/^~.*[.-]9999$/s/$/ **/' "${file}" > "${newfile}"
	done
	cat .kde-live/* >> kde-live.keywords
fi

# keywords for miscleanous packages from package.unmask/
for misc in kde-extras-live; do
	if [[ -f "../package.unmask/${misc}" ]]; then
		echo -e "${HEADER}" > "${misc}.keywords"
		sed '/^~.*[.-]9999$/s/$/ **/' "../package.unmask/${misc}" >> "${misc}.keywords"
	fi
done
popd > /dev/null

# regenerate unmask entries (base for package mask)
pushd ../package.unmask/ > /dev/null
for release in 4.8 4.9 live; do
	echo -e "${HEADER}" > "kde-${release}"
	if [[ -d ".kde-${release}" ]]; then
		cat ".kde-${release}/"* >> "kde-${release}"
	fi
done
popd > /dev/null

# regenerate package mask
pushd ../../profiles/ > /dev/null
echo -e "\
${HEADER}
# Edit profiles/package.mask.d/ files instead." > package.mask
if [[ -d package.mask.d ]]; then
	for masks in package.mask.d/*; do
		echo >> package.mask
		cat ${masks} >> package.mask
	done
fi
popd > /dev/null

# regenerate unversioned sets
RELEASE=${RELEASE:-4.8}
pushd ../../sets/ > /dev/null
for set in *-${RELEASE}; do
	newfile=${set/%-${RELEASE}}
	echo -e "${HEADER}" > "${newfile}"
	sed -r "/@/s/-${RELEASE}//g;/9999$/s/~//;s/<//;\@kde-base/@s/-(9999|4\..\.50)/:4/" "${set}" >> "${newfile}"
done
popd > /dev/null
